---
title: 'Project \(\lambda\) - statistical inference from experimental data'
author: "Wakinyan B."
date: "November 05, 2023"
output:
  pdf_document:
    toc: yes
    toc_depth: 4
    number_sections: yes
    highlight: tango
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
header-includes:
- \usepackage{stmaryrd}
encoding: UTF-8
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      fig.align = "center",
                      message = FALSE,
                      warning = FALSE,
                      results = 'show')

knitr::opts_knit$set(root.dir='C:/Users/wbenhamou/Desktop/LAMBDA/Data_and_codes/')
```
\newpage

# Initialization

```{r, results='hide'}
# Cleaning objects from the workplace
rm(list=ls())

# Packages (may first require installations: install.packages())
library(tidyverse) # for data manipulation
library(plyr) # for data manipulation
library(scales) # to manipulate the internal scaling infrastructure used by ggplot2
library(RColorBrewer) # for colors and palettes
library(gridExtra) # to show multiple plots
library(cowplot) # to show multiple plots
library(ggpubr) # to show multiple plots
library(deSolve) # to solve a system of ordinary differential equations
library(boot) # for the inverse logit function 'inv.logit'
library(forecast) # for auto.arima
library(ggcorrplot)

# Execute functions from external R script
source("Phage_Lambda_functions_v11.R")

Sys.setlocale("LC_TIME", "English")
```

# Import experimental data

## Import

```{r}
load("Data/Experimental_data_mean_and_figures.RData")
```

# MLE inference

```{r}
data <- merge.data.frame(data_FACS[,c(1:3,9:12)], data_qPCR[,c(1:3,6,8)], all=TRUE)

estim_alpha_exp <- estim_alpha(data, by_chemostat = FALSE)
(alpha_w <- estim_alpha_exp[["alpha_w"]])
(alpha_m <- estim_alpha_exp[["alpha_m"]])

K <- 1E+09
delta <- 0.8
B <- 80
```

Run 'estim_experimental_data_v11.R'.

```{r}
estim_df <- read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_B80_v11.csv",
                     header=TRUE)

best <- estim_df[which.min(estim_df$Value),]
best

best_parms <- best[,-(1:3)]
# write.csv(best_parms, "Outputs_csv/Best_parms_non_linear_optim_experimental_data.csv", row.names = FALSE)

best_parms$alpha_w <- alpha_w
best_parms$alpha_m <- alpha_m

(AIC <- 2*(ncol(best_parms)+best$Value)) # AIC = 2*(nb parameters - ln(likelihood))

best_parms$B <- B

# Basic reproduction numbers

(R0_w <- R0(alpha = best_parms$alpha_w, phi = best_parms$phi_w, a = best_parms$a, b = best_parms$b, tau = best_parms$tau, B = B,
            r = best_parms$r, S0 = K))
(R0_m <- R0(alpha = best_parms$alpha_m, phi = best_parms$phi_m, a = best_parms$a, b = best_parms$b, tau = best_parms$tau, B = B,
            r = best_parms$r, S0 = K))
```

```{r}
times <- seq(0,60,0.1)

best_simul <- rbind(lambda_simul(prev0 = best_parms[["prev0_epidemic"]], freq0 = best_parms[["freq0"]],
                                 parms = best_parms, times = times),
                    lambda_simul(prev0 = best_parms[["prev0_endemic"]], freq0 = best_parms[["freq0"]],
                                 parms = best_parms, times = times))

best_simul$prev0 <- c(1, 100) %>% rep(each = length(times))
```

```{r, eval=FALSE, fig.width = 9, fig.height = 3}
ggarrange(
  Fig_logit_prev.transparent + theme(legend.title = element_blank()),
  Fig_logit_g.transparent + theme(legend.title = element_blank()),
  Fig_logit_q.transparent + scale_y_continuous(breaks=seq(-2,10,2), limits=c(-2,10)) +
    theme(legend.title = element_blank()),
  ncol = 3, common.legend = TRUE, align = 'v')

# ggsave("lambda_experimental_data_h.png", width=9, height=3, dpi=600)

ggarrange(
  Fig_logit_prev.transparent + geom_line(data=best_simul, aes(group=prev0), cex = 1) +
    theme(legend.title = element_blank()),
  Fig_logit_g.transparent + geom_line(data=best_simul, aes(group=prev0), cex = 1) +
    theme(legend.title = element_blank()),
  Fig_logit_q.transparent + geom_line(data=best_simul, aes(group=prev0), cex = 1) +
    scale_y_continuous(breaks=seq(-2,10,2), limits=c(-2,10)) +
    theme(legend.title = element_blank()),
  ncol = 3, common.legend = TRUE, align = 'v')

# ggsave("lambda_fit_experimental_data_h.png", width=9, height=3, dpi=600)
```


```{r, fig.width = 4, fig.height = 9}
ggarrange(
  Fig_logit_prev.transparent + geom_line(data=best_simul, aes(group=prev0), cex = 1) +
    theme(axis.title.x = element_blank(), legend.title = element_blank()),
  Fig_logit_g.transparent + geom_line(data=best_simul, aes(group=prev0), cex = 1) +
    theme(axis.title.x = element_blank(), legend.title = element_blank()),
  Fig_logit_q.transparent + geom_line(data=best_simul, aes(group=prev0), cex = 1) +
    theme(legend.title = element_blank()),
  ncol=1, common.legend=TRUE, align='v', labels=LETTERS[1:3],
  label.x=0.96, label.y=0.96, font.label=list(size=13), hjust=1)
```

## Sieve bootstrap

```{r, fig.height=4, fig.width=9}
residuals <- ddply(data, ~chemostat, function(X){
  initial_prev <- unique(X$prev0)
  time <- X$time
  ysim <- subset(best_simul, prev0==initial_prev)
  ysim <- ysim[match(time, ysim$time),]
  return(data.frame("time" = X$time, "prev0" = initial_prev,
                    "logit_prev" = X$logit_prev - ysim$logit_prev,
                    "logit_g" = X$logit_g - ysim$logit_g,
                    "logit_q" = X$logit_q - ysim$logit_q))
  })

ggarrange(ggplot(residuals, aes(x=time, y=logit_prev, col=chemostat)) +
            geom_hline(yintercept = 0) + geom_line(),
          ggplot(residuals, aes(x=time, y=logit_g, col=chemostat)) +
            geom_hline(yintercept = 0) + geom_line(),
          ggplot(residuals, aes(x=time, y=logit_q, col=chemostat)) +
            geom_hline(yintercept = 0) + geom_line(),
          common.legend = TRUE, ncol=3)
```

```{r}
chemostat_names <- unique(residuals$chemostat)
n_chem <- length(chemostat_names)

L <- vector("list", n_chem)
names(L) <- chemostat_names

for(i in 1:length(L)){

  X <- subset(residuals, chemostat==names(L[i]))

  means <- c(mean(X$logit_prev, na.rm=TRUE), mean(X$logit_g, na.rm=TRUE), mean(X$logit_q, na.rm=TRUE))

  L[[i]] <- list("chemostat"=names(L[i]), "means"=means,
                 "logit_prev"=forecast::auto.arima(X$logit_prev-means[1], max.p=10, max.q=10,
                                                   stationary = TRUE, seasonal=FALSE),
                 "logit_g"=forecast::auto.arima(X$logit_g-means[2], max.p=10, max.q=10,
                                                stationary = TRUE, seasonal=FALSE),
                 "logit_q"=forecast::auto.arima(X$logit_q-means[3], max.p=10, max.q=10,
                                                stationary = TRUE, seasonal=FALSE))
}
```

```{r, fig.width=5,  fig.height=10}
residual.b <- lapply(L, function(Li){
  n <- 60
  n.burnin <- 10
  return(data.frame("chemostat" = Li$chemostat, "time"=1:n,
                    "logit_prev" = simul_ARMA(Li$logit_prev, n=n, n.burnin=n.burnin)+Li$means[1],
                    "logit_g" = simul_ARMA(Li$logit_g, n=n, n.burnin=n.burnin)+Li$means[2],
                    "logit_q" = simul_ARMA(Li$logit_q, n=n, n.burnin=n.burnin)+Li$means[3]))
  }) %>% bind_rows

ggarrange(ggplot(residuals, aes(x=time, y=logit_prev, col=chemostat)) +
            geom_hline(yintercept = 0) + geom_point(cex=0.5) +
            geom_line(data=residual.b),
          ggplot(residuals, aes(x=time, y=logit_g, col=chemostat)) +
            geom_hline(yintercept = 0) + geom_point(cex=0.5) +
            geom_line(data=residual.b),
          ggplot(residuals, aes(x=time, y=logit_q, col=chemostat)) +
            geom_hline(yintercept = 0) + geom_point(cex=0.5) +
            geom_line(data=residual.b),
          common.legend = TRUE, ncol=1)
```

```{r, eval=FALSE}
n.bs <- 10000

data.bs <- lapply(1:n.bs, function(i){
  data.bs_i <- bootstrapped_data(data, best_simul, L, seed=i)
  data.bs_i$id <- i 
  return(data.bs_i)
}) %>% bind_rows

# write.csv(data.bs, "Outputs_csv/Bootstrapped_data.csv", row.names = FALSE)
```

```{r}
best_parms <- read.csv("Outputs_csv/Best_parms_non_linear_optim_experimental_data.csv", header=TRUE)
```

Run 'estim_experimental_data_bootstrap_v11.R'.

### Joint distributions

```{r}
best_parms <- cbind("alpha_w"=alpha_w, "alpha_m"=alpha_m, best_parms)

estim_df_bs <- read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_bootstrap_B80_v11.csv")
estim_df_bs <- estim_df_bs[!estim_df_bs$Value==1E+10,]
estim_df_bs <- subset(estim_df_bs, Convergence==0)

(n <- nrow(estim_df_bs))

apply(estim_df_bs[,4:ncol(estim_df_bs)], 2, quantile, probs=c(0.025,0.975))

# Basic reproduction numbers

estim_df_bs$R0_w <- R0(alpha = estim_df_bs$alpha_w, phi = estim_df_bs$phi_w, a = estim_df_bs$a, b = estim_df_bs$b,
                       tau = estim_df_bs$tau, B = B, r = estim_df_bs$r, S0 = K)
estim_df_bs$R0_m <- R0(alpha = estim_df_bs$alpha_m, phi = estim_df_bs$phi_m, a = estim_df_bs$a, b = estim_df_bs$b,
                       tau = estim_df_bs$tau, B = B, r = estim_df_bs$r, S0 = K)

R0_w; quantile(estim_df_bs$R0_w, probs = c(0.025, 0.975))
R0_m; quantile(estim_df_bs$R0_m, probs = c(0.025, 0.975))
```

```{r, fig.height=9, fig.width=6}
plot_density <- function(estim, parm_label, best_parm){
  return(ggplot(data=as.data.frame(estim), aes(x=estim)) +
           geom_density(lwd=0.7, col="#ffa20b", fill="#ffa20b", alpha=0.3) +
           labs(x=parm_label,y="Density") +
           scale_y_continuous(expand=c(0,0)) +
           geom_vline(xintercept=best_parm, lwd=0.5) +
           geom_vline(xintercept=quantile(estim, probs = c(0.025,0.975)), col="darkred", lty="dashed", lwd=0.5) +
           theme_classic() + theme(axis.text.y = element_blank(), axis.title.y = element_text(size=8),
                                   axis.text.x = element_text(size=7), 
                                   axis.ticks.y = element_blank()))
}

plot_grid(
  plot_density(estim_df_bs$alpha_w, parm_label=expression(hat(alpha)[w]), best_parms$alpha_w) +
    scale_x_continuous(breaks=seq(0,2E-2,5E-3), labels=scientific_10),
  plot_density(estim_df_bs$alpha_m, parm_label=expression(hat(alpha)[m]), best_parms$alpha_m) +
    scale_x_continuous(breaks=seq(0,4E-2,1E-2)),
  plot_density(estim_df_bs$phi_w, parm_label=expression(hat(phi)[w]), best_parms$phi_w) +
    scale_x_continuous(breaks=seq(0,1,0.1)),
  plot_density(estim_df_bs$phi_m, parm_label=expression(hat(phi)[m]), best_parms$phi_m) +
    scale_x_continuous(breaks=seq(0,0.15,5E-2), labels = scientific_10),
  plot_density(estim_df_bs$a, parm_label=expression(hat(a)), best_parms$a) +
    scale_x_continuous(breaks=seq(2.5E-7,1E-6,2.5E-7), labels=scientific_10),
  plot_density(estim_df_bs$b, parm_label=expression(hat(b)), best_parms$b) +
    scale_x_continuous(breaks=seq(2.5E-2,1E-1,2.5E-2), labels=scientific_10),
  plot_density(estim_df_bs$r, parm_label=expression(hat(r)), best_parms$r) +
    scale_x_continuous(breaks=seq(0,5,0.5)),
  plot_density(estim_df_bs$tau, parm_label=expression(hat(tau)), best_parms$tau) +
    scale_x_continuous(breaks=seq(0,4,0.5)),
  plot_density(estim_df_bs$prev0_epidemic, parm_label=expression(hat(P)[0]^{epidemic}), best_parms$prev0_epidemic) +
    scale_x_continuous(breaks=seq(0,2E-2,5E-3), labels=scientific_10),
  plot_density(estim_df_bs$prev0_endemic, parm_label=expression(hat(P)[0]^{endemic}), best_parms$prev0_endemic) +
    scale_x_continuous(breaks=seq(0.97,1,5E-3)),
  plot_density(estim_df_bs$freq0, parm_label=expression(hat(p)[0]), best_parms$freq0) +
    scale_x_continuous(breaks=seq(0.4,0.6,0.05)),
  ncol=2, align='hv')
```

```{r, fig.height=4, fig.width=6}
plot_grid(
  plot_density(estim_df_bs$alpha_w, parm_label=expression(hat(alpha)[w]), best_parms$alpha_w) +
    scale_x_continuous(breaks=seq(0,2E-2,5E-3), labels=scientific_10),
  plot_density(estim_df_bs$alpha_m, parm_label=expression(hat(alpha)[m]), best_parms$alpha_m) +
    scale_x_continuous(breaks=seq(0,4E-2,1E-2)),
  plot_density(estim_df_bs$phi_w, parm_label=expression(hat(phi)[w]), best_parms$phi_w) +
    scale_x_continuous(breaks=seq(0,1,0.1)),
  plot_density(estim_df_bs$phi_m, parm_label=expression(hat(phi)[m]), best_parms$phi_m) +
    scale_x_continuous(breaks=seq(0,0.15,5E-2), labels = scientific_10),
  ncol=2, align='hv')

# ggsave("Phenotypic_traits_distributions.png", width=6, height=3, dpi=600)
```

### Correlations

```{r, fig.width=6, fig.height=5}
tab <- estim_df_bs[,4:(ncol(estim_df_bs))][,c(1:2,6:11,3:5,12:14)]

rho <- cor(tab)
pv_rho <- cor_pmat(tab)

rho_label <- c(expression(alpha[w]), expression(alpha[m]), expression(phi[w]), expression(phi[m]),
               "a", "b", "r", expression(tau), expression(P[0]^epidemic), expression(P[0]^endemic),
               expression(p[0]), expression(sigma[P]), expression(sigma[g]), expression(sigma[q]))

ggcorrplot(rho, method="circle", type="lower", colors=c("#6D9EC1", "white", "#E46726"), p.mat=pv_rho) +
  scale_x_discrete(label=rho_label[-1]) +
  scale_y_discrete(label=rho_label[-length(rho_label)]) +
  theme(legend.title=element_blank())
```

### Enveloppes of fitted values

```{r, eval=FALSE}
estim_df_bs$B <- 80

simul_bs <- lapply(1:n, function(i){
  print(i)
  return(rbind(
    cbind("id"=i, "prev0"=1,
          lambda_simul(prev0=estim_df_bs$prev0_epidemic[i], freq0=estim_df_bs$freq0[i], # epidemic treatment
                       parms=estim_df_bs[i,], times = seq(0,60,0.1), verbose=FALSE)),
    cbind("id"=i, "prev0"=100,
          lambda_simul(prev0=estim_df_bs$prev0_endemic[i], freq0=estim_df_bs$freq0[i], # endemic treatment
                       parms=estim_df_bs[i,], times = seq(0,60,0.1), verbose=FALSE))))
}) %>% bind_rows

# write.csv(simul_bs, "Outputs_csv/Simulations_bootstrap.csv", row.names=FALSE)
```

```{r}
simul_bs <- read.csv("Outputs_csv/Simulations_bootstrap.csv", header=TRUE)

simul_bs_quantile <- ddply(simul_bs, ~prev0+time, function(X){

  var <- c("logit_prev", "logit_g", "logit_q")
  proba <- c(0.025,0.5,0.975)
  
  return(X[,match(var, colnames(X))] %>% apply(2, quantile, probs=proba, na.rm=TRUE) %>% c %>%
           setNames(paste0(rep(var, each=3), "_", proba)))
})
```

```{r, fig.width = 4, fig.height = 9}
mytheme <- theme_bw()+theme(axis.title.x=element_text(size=10), axis.title.y=element_text(size=10),
                            axis.text.x=element_text(size=9), axis.text.y=element_text(size=9),
                            legend.title = element_blank())

ggarrange(
  ggplot(data=simul_bs_quantile, aes(x=time)) +
    geom_ribbon(aes(ymin=logit_prev_0.025, ymax=logit_prev_0.975, fill=as.factor(prev0)), alpha=0.2) +
    geom_line(aes(y=logit_prev_0.5, col=as.factor(prev0)), cex=0.5) +
    geom_point(data=data_FACS, aes(y=logit_prev, col=as.factor(prev0)), cex=0.3) +
    labs(x="time (hours)", y="Logit-prevalence\n") +
    scale_x_continuous(limits = c(0,60), breaks = seq(0, 60, 10)) +
    scale_y_continuous(limits = c(-9,12), labels = scales::label_number(accuracy = 1)) +
    scale_color_manual(labels = c("epidemic", "endemic"), values=c('#DA0F0F','#0E5DD6')) +
    scale_fill_manual(labels = c("epidemic", "endemic"), values=c('#DA0F0F','#0E5DD6')) +
    mytheme + theme(axis.title.x = element_blank()),
  
  ggplot(data=simul_bs_quantile, aes(x=time)) +
    geom_ribbon(aes(ymin=logit_g_0.025, ymax=logit_g_0.975, fill=as.factor(prev0)), alpha=0.2) +
    geom_line(aes(y=logit_g_0.5, col=as.factor(prev0)), cex=0.5) +
    geom_point(data=data_FACS, aes(y=logit_g, col=as.factor(prev0)), cex=0.3) +
    labs(x="time (hours)", y="Logit-frequency infected by virulent phage\n") +
    scale_x_continuous(limits = c(0,60), breaks = seq(0, 60, 10)) +
    scale_y_continuous(limits = c(-2,6), labels = scales::label_number(accuracy = 1)) +
    scale_color_manual(labels = c("epidemic", "endemic"), values=c('#DA0F0F','#0E5DD6')) +
    scale_fill_manual(labels = c("epidemic", "endemic"), values=c('#DA0F0F','#0E5DD6')) +
    mytheme + theme(axis.title.x = element_blank()),
  
  ggplot(data=simul_bs_quantile, aes(x=time)) +
    geom_ribbon(aes(ymin=logit_q_0.025, ymax=logit_q_0.975, fill=as.factor(prev0)), alpha=0.2) +
    geom_line(aes(y=logit_q_0.5, col=as.factor(prev0)), cex=0.5) +
    geom_point(data=data_qPCR, aes(y=logit_q, col=as.factor(prev0)), cex=0.3) +
    labs(x = "time (hours)", y="Logit-frequency free virulent phage\n") +
    scale_x_continuous(limits = c(0,60), breaks = seq(0, 60, 10)) +
    scale_y_continuous(limits = c(-2,10), labels = scales::label_number(accuracy = 1)) +
    scale_color_manual(labels = c("epidemic", "endemic"), values=c('#DA0F0F','#0E5DD6')) +
    scale_fill_manual(labels = c("epidemic", "endemic"), values=c('#DA0F0F','#0E5DD6')) +
    mytheme,
  
  ncol = 1, align='hv', common.legend = TRUE, labels=LETTERS[1:3],
  label.x=0.96, label.y=0.96, font.label=list(size=13), hjust=1)
```

```{r}
ggarrange(
  ggplot(data=simul_bs_quantile, aes(x=time)) +
    geom_ribbon(aes(ymin=logit_prev_0.025, ymax=logit_prev_0.975, fill=as.factor(prev0)), alpha=0.2) +
    geom_line(aes(y=logit_prev_0.5, col=as.factor(prev0)), cex=0.5) +
    geom_point(data=data_FACS, aes(y=logit_prev, col=as.factor(prev0)), cex=0.1) +
    labs(x="time (hours)", y="Logit-prevalence\n") +
    scale_x_continuous(limits = c(0,60), breaks = seq(0, 60, 10)) +
    scale_y_continuous(limits = c(-9,12), labels = scales::label_number(accuracy = 1)) +
    scale_color_manual(labels = c("epidemic", "endemic"), values=c('#DA0F0F','#0E5DD6')) +
    scale_fill_manual(labels = c("epidemic", "endemic"), values=c('#DA0F0F','#0E5DD6')) +
    mytheme,
  
  ggplot(data=simul_bs_quantile, aes(x=time)) +
    geom_ribbon(aes(ymin=logit_g_0.025, ymax=logit_g_0.975, fill=as.factor(prev0)), alpha=0.2) +
    geom_line(aes(y=logit_g_0.5, col=as.factor(prev0)), cex=0.5) +
    geom_point(data=data_FACS, aes(y=logit_g, col=as.factor(prev0)), cex=0.1) +
    labs(x="time (hours)", y="Logit-frequency infected by virulent phage\n") +
    scale_x_continuous(limits = c(0,60), breaks = seq(0, 60, 10)) +
    scale_y_continuous(limits = c(-2,6), labels = scales::label_number(accuracy = 1)) +
    scale_color_manual(labels = c("epidemic", "endemic"), values=c('#DA0F0F','#0E5DD6')) +
    scale_fill_manual(labels = c("epidemic", "endemic"), values=c('#DA0F0F','#0E5DD6')) +
    mytheme,
  
  ggplot(data=simul_bs_quantile, aes(x=time)) +
    geom_ribbon(aes(ymin=logit_q_0.025, ymax=logit_q_0.975, fill=as.factor(prev0)), alpha=0.2) +
    geom_line(aes(y=logit_q_0.5, col=as.factor(prev0)), cex=0.5) +
    geom_point(data=data_qPCR, aes(y=logit_q, col=as.factor(prev0)), cex=0.1) +
    labs(x = "time (hours)", y="Logit-frequency free virulent phage\n") +
    scale_x_continuous(limits = c(0,60), breaks = seq(0, 60, 10)) +
    scale_y_continuous(limits = c(-2,10), labels = scales::label_number(accuracy = 1)) +
    scale_color_manual(labels = c("epidemic", "endemic"), values=c('#DA0F0F','#0E5DD6')) +
    scale_fill_manual(labels = c("epidemic", "endemic"), values=c('#DA0F0F','#0E5DD6')) +
    mytheme,
  
  ncol = 3, align='hv', common.legend = TRUE)

# ggsave("lambda_fit_experimental_data_bs_h.png", width=9, height=3, dpi=600)
```
## Sensitivity analysis

### Perturbation of parameter B

Run 'estim_experimental_data_v11_varB.R'.

```{r, fig.width=8, fig.height=2}
estim_df_varB <- rbind(
  cbind("B"=60,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_B60_v11.csv", header=TRUE)),
  cbind("B"=72,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_B72_v11.csv", header=TRUE)),
  cbind("B"=88,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_B88_v11.csv", header=TRUE)),
  cbind("B"=100,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_B100_v11.csv", header=TRUE)),
  cbind("B"=120,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_B120_v11.csv", header=TRUE)))

best_varB <- ddply(estim_df_varB, ~B, function(X){
  X <- subset(X, Convergence=="Successful completion")
  return(X[which.min(X$Value),])
}) %>% rbind(cbind("B"=B, best))

# best_varB$b*best_varB$B

best_parms_B80 <- best_parms[,match(colnames(best_varB[,-(1:4)]), names(best_parms))]

rel_var <- apply(best_varB[,-(1:4)], 1, function(X){
  return(X/best_parms_B80-1)
}) %>% bind_rows

rel_var$B <- best_varB$B %>% paste0(" (", add_plus_sign(100*(best_varB$B/B-1), digits = 0), "%)") %>%
  gsub(pattern = " \\( 0%\\)", replacement = "", x = .)

rel_var$B <- rel_var$B %>% factor(levels=rel_var$B[c(1:2,6,3:5)])

rel_var <- rel_var %>% tidyr::gather(parameter, relative_variation, -B)

rel_var$parameter <- rel_var$parameter %>% factor(levels=c("phi_w", "phi_m", "a", "b", "r", "tau",
                                                           "prev0_epidemic", "prev0_endemic", "freq0",
                                                           "sigma_prev", "sigma_g", "sigma_q"))

ggplot(rel_var, aes(x=parameter, y=relative_variation, col=as.factor(B))) +
  geom_hline(yintercept = 0, lty = 'dashed') +
  geom_point(size=3, alpha=0.75) +
  labs(y="Relative variation\n", col="Burst size (B)") +
  scale_color_manual(values = RColorBrewer::brewer.pal(7, "YlOrRd")[-1]) +
  scale_x_discrete(labels=c(expression(hat(phi)[w]), expression(hat(phi)[m]),
                            expression(hat(a)), expression(hat(b)), expression(hat(r)), expression(hat(tau)),
                            expression(hat(P)[0]^{epidemic}), expression(hat(P)[0]^{endemic}), expression(hat(p)[0]),
                            expression(hat(sigma)[P]), expression(hat(sigma)[g]), expression(hat(sigma)[q]))) +
  scale_y_continuous(breaks=seq(-0.3,0.3,0.1), labels = scales::percent) +
  theme_bw() +
  theme(axis.text.x = element_text(size=11, angle=25, hjust=1), axis.title.x = element_blank(),
        axis.text.y = element_text(size=10), axis.title.y = element_text(size = 12)) # pdf landscape : 8 x 2
```

### Perturbation of parameter a

Run 'estim_experimental_data_v11_vara.R'.

```{r, fig.width=8, fig.height=3}
estim_df_vara <- rbind(
  cbind("a"=1e-09,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_a1e-09_v11.csv", header=TRUE)),
  cbind("a"=1e-08,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_a1e-08_v11.csv", header=TRUE)),
  cbind("a"=1e-07,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_a1e-07_v11.csv", header=TRUE)),
  cbind("a"=1e-06,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_a1e-06_v11.csv", header=TRUE)),
  cbind("a"=1e-04,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_a1e-04_v11.csv", header=TRUE)),
  cbind("a"=0.01,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_a0.01_v11.csv", header=TRUE)),
  cbind("a"=1,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_a1_v11.csv", header=TRUE)))

best_vara <- ddply(estim_df_vara, ~a, function(X){
  X <- subset(X, Convergence=="Successful completion")
  return(X[which.min(X$Value),])
})

phi_ratio <- best_vara$phi_w/best_vara$phi_m
(phi_ratio/phi_ratio[4]-1)*100

rel_var <- apply(best_vara[,-(1:4)], 1, function(X){
  return(X/best_vara[best_vara$a==1e-06,-(1:4)]-1)
}) %>% bind_rows

rel_var$a <- best_vara$a
rel_var <- rel_var %>% tidyr::gather(parameter, relative_variation, -a)

rel_var$parameter <- rel_var$parameter %>% factor(levels=c("phi_w", "phi_m", "r", "b", "tau",
                                                           "prev0_epidemic", "prev0_endemic", "freq0",
                                                           "sigma_prev", "sigma_g", "sigma_q"))

(Fig_relvar_a <- ggplot(rel_var, aes(x=parameter, y=relative_variation, col=as.factor(a))) +
    geom_hline(yintercept = 0, lty = 'dashed') +
    geom_point(size=3, alpha=0.75) +
    labs(y="Relative variation\n", col="Adsorption rate (a)") +
    scale_color_manual(values=colorRampPalette(c("#c0f1a0", "#116d0c"))(7),
                       labels=c(expression(10^{-9}), expression(10^{-8}), expression(10^{-7}),
                                expression(paste(10^{-6}," (best MLE estimate)")), expression(10^{-4}),
                                      expression(10^{-2}),expression(1))) +
    scale_x_discrete(labels=c(expression(hat(phi)[w]), expression(hat(phi)[m]),
                              expression(hat(r)), expression(hat(b)), expression(hat(tau)),
                              expression(hat(P)[0]^{epidemic}), expression(hat(P)[0]^{endemic}),
                              expression(hat(p)[0]), expression(hat(sigma)[P]), expression(hat(sigma)[g]),
                              expression(hat(sigma)[q]))) +
    scale_y_continuous(breaks=c(seq(-0.5,3,0.5)), labels = scales::percent) +
    theme_bw() +
    theme(axis.text.x = element_text(size=11, angle=25, hjust=1), axis.title.x = element_blank(),
          axis.text.y = element_text(size=10), axis.title.y = element_text(size = 12),
          legend.text = element_text(hjust=0))) # pdf landscape : 8 x 2
```

### Perturbation of parameter r

Run 'estim_experimental_data_v11_varr.R'.

```{r, fig.width=8, fig.height=3}
estim_df_varr <- rbind(
  cbind("r"=1,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_r1_v11.csv", header=TRUE)),
  cbind("r"=2,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_r2_v11.csv", header=TRUE)),
  cbind("r"=3,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_r3_v11.csv", header=TRUE)),
  cbind("r"=4,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_r4_v11.csv", header=TRUE)),
  cbind("r"=5,
        read.csv("Outputs_csv/Estim_nmk_parallel_experimental_data_nstarts2000_r5_v11.csv", header=TRUE)))

best_varr <- ddply(estim_df_varr, ~r, function(X){
  X <- subset(X, Convergence=="Successful completion")
  return(X[which.min(X$Value),])
}) %>% rbind(best)

phi_ratio <- best_varr$phi_w/best_varr$phi_m
(phi_ratio/phi_ratio[6]-1)*100

index <- best_varr[,-(1:4)] %>% colnames %>% match(colnames(best_parms)) %>% na.omit

rel_var <- apply(best_varr[,-(1:4)], 1, function(X){
  return(X/best_parms[,index]-1)
}) %>% bind_rows

rel_var$r <- best_varr$r

rel_var$r[nrow(rel_var)] <- rel_var$r[nrow(rel_var)] %>% round(digits=3) %>% paste("(best MLE estimate)")

rel_var <- rel_var %>% tidyr::gather(parameter, relative_variation, -r)

rel_var$parameter <- rel_var$parameter %>% factor(levels=c("phi_w", "phi_m", "a", "b", "tau",
                                                           "prev0_epidemic", "prev0_endemic", "freq0",
                                                           "sigma_prev", "sigma_g", "sigma_q"))

(Fig_relvar_r <- ggplot(rel_var, aes(x=parameter, y=relative_variation, col=r)) +
    geom_hline(yintercept = 0, lty = 'dashed') +
    geom_point(size=3, alpha=0.75) +
    labs(y="Relative variation\n", col="Bacterial intrinsic\ngrowth rate (r)") +
    scale_color_manual(values = colorRampPalette(c("#AED4E7", "#0A6295"))(6)) +
    scale_x_discrete(labels=c(expression(hat(phi)[w]), expression(hat(phi)[m]),
                              expression(hat(a)), expression(hat(b)), expression(hat(tau)),
                              expression(hat(P)[0]^{epidemic}), expression(hat(P)[0]^{endemic}), expression(hat(p)[0]),
                              expression(hat(sigma)[P]), expression(hat(sigma)[g]), expression(hat(sigma)[q]))) +
    scale_y_continuous(breaks=seq(-0.5,0.75,0.25), labels = scales::percent) +
    theme_bw() +
    theme(axis.text.x = element_text(size=11, angle=25, hjust=1), axis.title.x = element_blank(),
          axis.text.y = element_text(size=10), axis.title.y = element_text(size = 12))) # pdf landscape : 8 x 2
```

```{r, fig.width=8, fig.height=6}
plot_grid(Fig_relvar_a, Fig_relvar_r, ncol=1, labels=paste0(LETTERS[1:2],")"), align = 'v')
```

